function repairsDetails(e=!0){let t=function(){displayElementsBySelector(".input-names","none"),displayElementsBySelector(".phone","none"),displayElementsBySelector(".inv","none"),displayElementsBySelector(".customer-out","none"),document.querySelector(".table-conteiner").classList.add("short-form")},o=function(){displayElementsBySelector(".input-names","initial"),displayElementsBySelector(".phone","initial"),displayElementsBySelector(".inv","initial"),displayElementsBySelector(".customer-out","initial"),document.querySelector(".table-conteiner").classList.remove("short-form")};document.querySelector("#show-all-columns").addEventListener("click",function(){defaultSettings.update(),1==this.checked?o():t()}),1==e?(o(),document.querySelector("#show-all-columns").checked=!0):(t(),document.querySelector("#show-all-columns").checked=!1)}function displayElementsBySelector(e,t){document.querySelectorAll(e).forEach((e,o)=>{e.style.display=t})}function loadRepairs(e=1){let t={number:parseInt(document.querySelector("#rows-per-page").value),currentPage:e,activeRepairs:document.querySelector("#active-repairs").checked};const o=document.querySelector(".table-conteiner");postData(o.dataset.fetch,t,"load_repairs").then(t=>{const n=document.querySelectorAll(".table-conteiner .item-conteiner");n.forEach((e,t)=>{t>0&&e.remove()});let r=new DocumentFragment;t.repairs.forEach((e,t)=>{let o=n[0].cloneNode(!0);o.querySelector(".attribute").innerText=e.id,o.querySelector(".attribute.date-in").innerText=addTimeZone(e.dateIn,toString=!0),o.querySelector(".attribute.customer-in").innerText=e.customerIn,o.querySelector(".attribute.employee").innerText=e.employee,o.querySelector(".attribute.department").innerText=e.department,o.querySelector(".attribute.phone").innerText=e.phone,o.querySelector(".attribute.equipment").innerText=e.equipment,o.querySelector(".attribute.inv").innerText=e.invNumber,o.querySelector(".attribute.defect").innerText=e.defect,o.querySelector(".attribute.work").innerText=e.repair,o.querySelector(".attribute.note").innerText=e.currentState,o.querySelector(".attribute.customer-out").innerText=e.customerOut,o.querySelector(".attribute.date-out").innerText=addTimeZone(e.dateOut,toString=!0),o.querySelector(".attribute.date-in").title=addTimeZone(e.dateIn,toString=!0),o.querySelector(".attribute.customer-in").title=e.customerIn,o.querySelector(".attribute.employee").title=e.employee,o.querySelector(".attribute.department").title=e.department,o.querySelector(".attribute.phone").title=e.phone,o.querySelector(".attribute.equipment").title=e.equipment,o.querySelector(".attribute.inv").title=e.invNumber,o.querySelector(".attribute.defect").title=e.defect,o.querySelector(".attribute.work").title=e.repair,o.querySelector(".attribute.note").title=e.currentState,o.querySelector(".attribute.customer-out").title=e.customerOut,o.querySelector(".attribute.date-out").title=addTimeZone(e.dateOut,toString=!0),r.appendChild(o)}),o.appendChild(r),showPagination(e,t.paginator,5),document.querySelector("#db-time-update").innerText=t.time}).catch(e=>{infoBlock("error",e)})}function saveRepair(){let e,t,o;e=""===document.querySelector("#modal-date-in").value?null:flatpickr.parseDate(document.querySelector("#modal-date-in").value,"d.m.y H:i"),t=""===document.querySelector("#modal-date-out").value?null:flatpickr.parseDate(document.querySelector("#modal-date-out").value,"d.m.y H:i"),o=document.querySelector("#modal-customer-out").selectedIndex>0?document.querySelector("#modal-customer-out").value:null;let n={date_in:e,location:document.querySelector("#modal-location").value,equipment:document.querySelector("#modal-equipment-model").value,defect:document.querySelector("#modal-defect").value,inv_number:document.querySelector("#modal-inv").value,customer_in:document.querySelector("#modal-customer-in").value,employee:document.querySelector("#modal-employee").value,repair:document.querySelector("#modal-repair").value,current_state:document.querySelector("#modal-current-state").value,date_out:t,customer_out:o},r=document.querySelector("#modal-id").innerText;r.search("\\*")<0?n.id=r:n.id=-1;const a=document.querySelector("#modal-form").action;postData(a,n,"save").then(e=>{!0===e.status?(modal.close("modal-current-row"),infoBlock("success",e.message,2e3),loadRepairs()):infoBlock("error",e.message)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function openRepair(e){const t={id:e.querySelector(":first-child").innerHTML},o=document.querySelector("#modal-form").action;postData(o,t,"open").then(e=>{modal.open("modal-current-row"),document.querySelector("#modal-id").innerHTML=e.repair.id;flatpickr("#modal-date-in",cfgFlatpickr).setDate(addTimeZone(e.repair.date_in));const t=flatpickr("#modal-date-out",cfgFlatpickr);null==e.repair.date_out?t.clear():t.setDate(addTimeZone(e.repair.date_out));const o=setOptions(e.departments,"departments"),n=setOptions(e.locations,"locations"),r=setOptions(e.buildings,"buildings"),a=e.locations.find(t=>t.id===e.repair.location).phone,l=setOptions(e.types,"types"),c=setOptions(e.brands,"brands"),d=setOptions(e.equipment,"equipment"),u=setOptions(e.employees,"names"),i=setOptions(e.customers,"names");document.querySelector("#modal-department").innerHTML="",document.querySelector("#modal-location").innerHTML="",document.querySelector("#modal-new-location-building").innerHTML="",document.querySelector("#modal-department-for-new-employee").innerHTML="",document.querySelector("#modal-department-for-new-location").innerHTML="",document.querySelector("#modal-equipment-type").innerHTML="",document.querySelector("#modal-new-equipment-type-id").innerHTML="",document.querySelector("#modal-equipment-brand").innerHTML="",document.querySelector("#modal-new-equipment-brand").innerHTML="",document.querySelector("#modal-equipment-model").innerHTML="",document.querySelector("#modal-customer-in").innerHTML="",document.querySelector("#modal-employee").innerHTML="",document.querySelector("#modal-customer-out").innerHTML="",document.querySelector("#modal-department").appendChild(o.cloneNode(!0)),document.querySelector("#modal-location").appendChild(n),document.querySelector("#modal-new-location-building").appendChild(r),document.querySelector("#modal-department-for-new-employee").appendChild(o.cloneNode(!0)),document.querySelector("#modal-department-for-new-location").appendChild(o),document.querySelector("#modal-equipment-type").appendChild(l.cloneNode(!0)),document.querySelector("#modal-new-equipment-type-id").appendChild(l),document.querySelector("#modal-equipment-brand").appendChild(c.cloneNode(!0)),document.querySelector("#modal-new-equipment-brand").appendChild(c),document.querySelector("#modal-equipment-model").appendChild(d),document.querySelector("#modal-customer-in").appendChild(i.cloneNode(!0)),document.querySelector("#modal-employee").appendChild(u),document.querySelector("#modal-customer-out").appendChild(i),document.querySelector("#modal-department").value=e.repair.department,document.querySelector("#modal-location").value=e.repair.location,document.querySelector("#modal-phone").value=a,document.querySelector("#modal-customer-in").value=e.repair.customer_in,document.querySelector("#modal-equipment-type").value=e.repair.type,document.querySelector("#modal-new-equipment-type-id").value="",document.querySelector("#modal-equipment-brand").value=e.repair.brand,document.querySelector("#modal-new-equipment-brand").value="",document.querySelector("#modal-equipment-model").value=e.repair.equipment,document.querySelector("#modal-inv").value=e.repair.inv_number,document.querySelector("#modal-employee").value=e.repair.employee,document.querySelector("#modal-defect").value=e.repair.defect,document.querySelector("#modal-repair").value=e.repair.repair,document.querySelector("#modal-current-state").value=e.repair.current_state,document.querySelector("#modal-customer-out").value=e.repair.customer_out,checkDepartment(),checkEquipmentTypeAndBrand(),e.readOnly?readOnly("#modal-current-row").on():readOnly("#modal-current-row").off()}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function removeRepair(e){const t=e.querySelector(":first-child").innerHTML,o={id:t};if(!window.confirm(`Вы действительно хотите удалить строку с номером: ${t}?`))return;const n=document.querySelector(".table-conteiner").dataset.fetch;postData(n,o,"remove").then(e=>{e.status?(infoBlock("info",e.message,2e3),loadRepairs()):infoBlock("error",e.message)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function copyRepair(e){const t={id:e.querySelector(":first-child").innerHTML},o=document.querySelector("#modal-form").action;postData(o,t,"copy").then(e=>{e.status?(infoBlock("info",e.message,2e3),loadRepairs()):infoBlock("error",e.message)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function addRepair(){const e=document.querySelector("#modal-form").action;postData(e,{},"open_new_form").then(e=>{if(e.readOnly)return void infoBlock("info","У вас нет прав для создания новой записи.",5e3);readOnly("#modal-current-row").off(),modal.open("modal-current-row"),document.querySelector("#modal-id").innerHTML=`${e.newid}*`;const t=flatpickr("#modal-date-in",cfgFlatpickr),o=flatpickr("#modal-date-out",cfgFlatpickr);t.setDate(new Date),o.clear();const n=setOptions(e.departments,"departments"),r=setOptions(e.types,"types"),a=setOptions(e.brands,"brands"),l=setOptions(e.employees,"names"),c=setOptions(e.buildings,"buildings");document.querySelector("#modal-department").innerHTML="",document.querySelector("#modal-location").innerHTML="",document.querySelector("#modal-new-location-building").innerHTML="",document.querySelector("#modal-department-for-new-employee").innerHTML="",document.querySelector("#modal-department-for-new-location").innerHTML="",document.querySelector("#modal-equipment-type").innerHTML="",document.querySelector("#modal-new-equipment-type-id").innerHTML="",document.querySelector("#modal-equipment-brand").innerHTML="",document.querySelector("#modal-new-equipment-brand").innerHTML="",document.querySelector("#modal-equipment-model").innerHTML="",document.querySelector("#modal-customer-in").innerHTML="",document.querySelector("#modal-employee").innerHTML="",document.querySelector("#modal-customer-out").innerHTML="",document.querySelector("#modal-department").appendChild(n.cloneNode(!0)),document.querySelector("#modal-department-for-new-employee").appendChild(n.cloneNode(!0)),document.querySelector("#modal-department-for-new-location").appendChild(n),document.querySelector("#modal-equipment-type").appendChild(r.cloneNode(!0)),document.querySelector("#modal-new-equipment-type-id").appendChild(r),document.querySelector("#modal-equipment-brand").appendChild(a.cloneNode(!0)),document.querySelector("#modal-new-equipment-brand").appendChild(a),document.querySelector("#modal-employee").appendChild(l),document.querySelector("#modal-new-location-building").appendChild(c),document.querySelector("#modal-department").value="",document.querySelector("#modal-location").value="",document.querySelector("#modal-phone").value="",document.querySelector("#modal-customer-in").value="",document.querySelector("#modal-equipment-type").value="",document.querySelector("#modal-new-equipment-type-id").value="",document.querySelector("#modal-equipment-brand").value="",document.querySelector("#modal-new-equipment-brand").value="",document.querySelector("#modal-inv").value="",document.querySelector("#modal-employee").value=e.defaultEmployee,document.querySelector("#modal-defect").value="",document.querySelector("#modal-repair").value="",document.querySelector("#modal-current-state").value="",document.querySelector("#modal-customer-out").value="",checkDepartment(),checkEquipmentTypeAndBrand()}).catch(e=>{modal.close("modal-current-row"),infoBlock("error",`${arguments.callee.name} | ${e}`)})}function addRowToAuxiliaryTable(e,t){const o=getAuxiliaryForm(t);postData(e,o,"add_row_to_auxiliary_table").then(t=>{if(t.status)switch(modal.close("modal-auxiliary"),infoBlock("info",t.message,2e3),o.table){case"locations":case"employees":changeDepartment();break;case"equipment":changeEquipmentTypeOrBrand();break;default:return getAuxiliaryTable(e,o.table)}else infoBlock("error",t.message)}).then(e=>{void 0!==e&&updateAuxiliaryForm(e.data,t)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function getAuxiliaryTable(e,t){const o={table:t};return postData(e,o,"get_auxiliary_table").then(e=>e)}function updateAuxiliaryForm(e,t){switch(t){case"modal-department-add":let o=setOptions(e,"departments");document.querySelector("#modal-department").innerHTML="",document.querySelector("#modal-department").appendChild(o.cloneNode(!0)),document.querySelector("#modal-department-for-new-employee").innerHTML="",document.querySelector("#modal-department-for-new-employee").appendChild(o.cloneNode(!0)),document.querySelector("#modal-department-for-new-location").innerHTML="",document.querySelector("#modal-department-for-new-location").appendChild(o);break;case"modal-location-add":let n=setOptions(e,"locations");document.querySelector("#modal-location").innerHTML="",document.querySelector("#modal-location").appendChild(n);break;case"modal-employee-add":let r=setOptions(e,"names");document.querySelector("#modal-customer-in").innerHTML="",document.querySelector("#modal-customer-in").appendChild(r.cloneNode(!0)),document.querySelector("#modal-employee").innerHTML="",document.querySelector("#modal-employee").appendChild(r.cloneNode(!0)),document.querySelector("#modal-customer-out").innerHTML="",document.querySelector("#modal-customer-out").appendChild(r.cloneNode(!0));break;case"modal-equipment-model-add":let a=setOptions(e,"equipment");document.querySelector("#modal-equipment-name").innerHTML="",document.querySelector("#modal-equipment-name").appendChild(a);break;case"modal-equipment-type-add":let l=setOptions(e,"types");document.querySelector("#modal-equipment-type").innerHTML="",document.querySelector("#modal-equipment-type").appendChild(l.cloneNode(!0)),document.querySelector("#modal-new-equipment-type-id").innerHTML="",document.querySelector("#modal-new-equipment-type-id").appendChild(l);break;case"modal-brand-add":let c=setOptions(e,"brands");document.querySelector("#modal-equipment-brand").innerHTML="",document.querySelector("#modal-equipment-brand").appendChild(c.cloneNode(!0)),document.querySelector("#modal-new-equipment-brand").innerHTML="",document.querySelector("#modal-new-equipment-brand").appendChild(c)}}function changeDepartment(){const e=document.querySelector("#modal-department");if(checkDepartment(),0===e.selectedIndex)return;""===document.querySelector("#modal-date-in").value?docDate=new Date:docDate=flatpickr.parseDate(document.querySelector("#modal-date-in").value,"d.m.y H:i");const t={id:e.value,date:docDate};console.log(t);const o=document.querySelector("#modal-form").action;postData(o,t,"change_department").then(e=>{let t=setOptions(e.locations,"locations");document.querySelector("#modal-location").innerHTML="",document.querySelector("#modal-location").appendChild(t);let o=setOptions(e.employees,"names");document.querySelector("#modal-customer-in").innerHTML="",document.querySelector("#modal-customer-in").appendChild(o.cloneNode(!0)),document.querySelector("#modal-customer-out").innerHTML="",document.querySelector("#modal-customer-out").appendChild(o)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function changeEquipmentTypeOrBrand(){checkEquipmentTypeAndBrand();const e=document.querySelector("#modal-equipment-type"),t=document.querySelector("#modal-equipment-brand");if(0===e.selectedIndex||0===t.selectedIndex)return;const o={type:e.value,brand:t.value},n=document.querySelector("#modal-form").action;postData(n,o,"change_equipment_type_or_brand").then(e=>{let t=setOptions(e.equipment,"equipment");document.querySelector("#modal-equipment-model").innerHTML="",document.querySelector("#modal-equipment-model").appendChild(t)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function updateIDSeq(){const e=document.querySelector("#modal-form").action;postData(e,{},"update_id_seq").then(e=>{console.log(e.data),infoBlock("success",e.message,2e3)}).catch(e=>{infoBlock("error",`${arguments.callee.name} | ${e}`)})}function checkDepartment(){const e=document.querySelector("#modal-department").selectedIndex,t=document.querySelector("#modal-location"),o=document.querySelector("#modal-customer-in"),n=document.querySelector("#modal-customer-out");0!==e?(t.disabled=!1,o.disabled=!1,n.disabled=!1):(t.innerHTML="",o.innerHTML="",n.innerHTML="",t.disabled=!0,o.disabled=!0,n.disabled=!0)}function checkEquipmentTypeAndBrand(){const e=document.querySelector("#modal-equipment-type").selectedIndex,t=document.querySelector("#modal-equipment-brand").selectedIndex,o=document.querySelector("#modal-equipment-model");0!==e&&0!==t?o.disabled=!1:(o.innerHTML="",o.disabled=!0)}function setOptions(e,t=""){let o=new DocumentFragment,n="";o.appendChild(document.createElement("option"));for(let r of e){for(let e in r)r.hasOwnProperty(e)&&null===r[e]&&(r[e]="");let e=document.createElement("option");switch(t){case"locations":n=`${r.office}`;break;case"names":n=`${r.l_name} ${r.f_name} ${r.patronymic}`;break;case"equipment":n=`${r.model}`;break;default:n=`${r.name}`}e.value=r.id,e.innerText=n,r.phone&&e.setAttribute("data-phone",r.phone),o.appendChild(e)}return o}const readOnly=e=>{const t=document.querySelectorAll(`${e} input`),o=document.querySelectorAll(`${e} select`),n=document.querySelectorAll(`${e} button`);return this.off=(()=>{t.forEach((e,t)=>{"modal-phone"!==e.id&&(e.disabled=!1)}),o.forEach((e,t)=>{e.disabled=!1}),n.forEach((e,t)=>{e.disabled=!1})}),this.on=(()=>{t.forEach((e,t)=>{e.disabled=!0}),o.forEach((e,t)=>{e.disabled=!0}),n.forEach((e,t)=>{e.classList.contains("btn-secondary")||(e.disabled=!0)})}),this},defaultSettings={update:()=>{const e={numberRowsPerPage:document.querySelector("#rows-per-page").value,repairsDetails:document.querySelector("#show-all-columns").checked,activeRepairs:document.querySelector("#active-repairs").checked,updateRepair:document.querySelector("#update-repairs").checked};localStorage.setItem("repairs",JSON.stringify(e))},apply:()=>{if(localStorage.repairs){const e=JSON.parse(localStorage.getItem("repairs"));document.querySelector("#rows-per-page").value=e.numberRowsPerPage,document.querySelector("#show-all-columns").checked=e.repairsDetails,document.querySelector("#active-repairs").checked=e.activeRepairs,document.querySelector("#update-repairs").checked=e.updateRepair}else document.querySelector("#rows-per-page").value="20",document.querySelector("#show-all-columns").checked=!1,document.querySelector("#active-repairs").checked=!1,document.querySelector("#update-repairs").checked=!1}};docReady(function(){defaultSettings.apply(),repairsDetails(document.querySelector("#show-all-columns").checked),loadRepairs(),document.querySelectorAll(".btn-x").forEach((e,t)=>{const o=`#${e.previousElementSibling.id}`;e.addEventListener("click",()=>{flatpickr(o,cfgFlatpickr).clear()})}),document.querySelector(".table-conteiner").addEventListener("click",function(e){this.querySelectorAll("li.item-conteiner").forEach((e,t)=>{e.classList.contains("table-active-row")&&e.classList.remove("table-active-row")});const t=e.target.closest("li.item-conteiner:not(:first-child)");t&&t.classList.add("table-active-row")}),document.querySelector(".table-conteiner").addEventListener("dblclick",function(e){const t=e.target.closest("li.item-conteiner:not(:first-child)");t&&openRepair(t)}),document.querySelector("#edit-row").addEventListener("click",()=>{const e=document.querySelector(".table-conteiner .table-active-row");e?openRepair(e):infoBlock("info","Нет выделенных строк.",5e3)}),document.querySelector("#remove-row").addEventListener("click",()=>{const e=document.querySelector(".table-conteiner .table-active-row");e?removeRepair(e):infoBlock("info","Нет выделенных строк.",5e3)}),document.querySelector("#add-row").addEventListener("click",()=>{addRepair()}),document.querySelector("#copy-row").addEventListener("click",()=>{const e=document.querySelector(".table-conteiner .table-active-row");e?copyRepair(e):infoBlock("info","Нет выделенных строк.",5e3)}),document.querySelector("#modal-form").addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation(),saveRepair()}),document.querySelector("#active-repairs").addEventListener("click",()=>{defaultSettings.update(),loadRepairs()}),document.querySelector("#rows-per-page").addEventListener("change",()=>{defaultSettings.update(),loadRepairs()}),document.querySelector(".pagination").addEventListener("click",e=>{event.preventDefault(),event.stopPropagation();const t=e.target.closest("a");t&&loadRepairs(t.dataset.page)});var e;document.querySelector("#update-repairs").addEventListener("click",function(){defaultSettings.update(),1==this.checked?(e&&window.clearInterval(e),e=window.setInterval(loadRepairs,6e4)):window.clearInterval(e)}),document.querySelector("#modal-customer-out").addEventListener("change",function(){this.selectedIndex>0?flatpickr("#modal-date-out",cfgFlatpickr).setDate(new Date):flatpickr("#modal-date-out",cfgFlatpickr).clear()}),document.querySelector("#modal-location").addEventListener("change",()=>{const e=document.querySelector("#modal-location").selectedOptions;document.querySelector("#modal-phone").value=e[0].getAttribute("data-phone")}),document.querySelectorAll(".open-auxiliary-modal").forEach((e,t)=>{const o=e.previousElementSibling.id;e.addEventListener("click",()=>{openAuxiliaryModal(o)})}),document.querySelector("#modal-department").addEventListener("change",changeDepartment),document.querySelector("#modal-equipment-type").addEventListener("change",changeEquipmentTypeOrBrand),document.querySelector("#modal-equipment-brand").addEventListener("change",changeEquipmentTypeOrBrand),document.querySelectorAll(".modal-auxiliary-form").forEach((e,t)=>{e.addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation(),"none"!==this.style.display&&addRowToAuxiliaryTable(this.action,this.id)})})});